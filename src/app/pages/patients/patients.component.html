<div class="dashboard-container">
  <app-sidebar [isOpen]="isSidebarOpen"></app-sidebar>

  <main class="main-content">
    <app-navbar (toggleSidebar)="toggleSidebar()"></app-navbar>

    <div class="page-content">
      <div class="page-header">
        <h1>Patients Management</h1>
        <button class="btn btn-primary" (click)="navigateToAddPatient()">
          <i class="fas fa-plus"></i> New Patient
        </button>
      </div>

      <!-- Success Message -->
      <div *ngIf="successMessage" class="success-message">
        <i class="fas fa-check-circle"></i> {{successMessage}}
      </div>

      <!-- Loading and Error States -->
      <div *ngIf="loading" class="loading-message">
        <i class="fas fa-spinner fa-spin"></i> Loading patients...
      </div>

      <div *ngIf="error" class="error-message">
        <i class="fas fa-exclamation-triangle"></i> {{error}}
        <button class="btn btn-sm btn-primary" (click)="loadPatients()">Retry</button>
      </div>

      <!-- Search and Filters -->
      <div class="filters-section" *ngIf="!loading">
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input
            type="text"
            placeholder="Search by Name or National ID"
            [(ngModel)]="searchTerm"
          >
        </div>

        <div class="filters">
          <div class="date-filter">
            <label>Registration Date:</label>
            <input
              type="date"
              [(ngModel)]="dateFilter"
              class="filter-input"
            >
          </div>
        </div>
      </div>

      <!-- Patients Table -->
      <div class="table-container" *ngIf="!loading && patients.length > 0">
        <table class="patients-table">
          <thead>
            <tr>
              <th>Patient ID</th>
              <th>Name</th>
              <th>Age</th>
              <th>Gender</th>
              <th>Contact</th>
              <th>National ID</th>
              <th>Registration Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let patient of paginatedPatients">
              <td>{{patient.id}}</td>
              <td>{{getFullName(patient)}}</td>
              <td>{{calculateAge(patient.date_of_birth)}}</td>
              <td>{{patient.gender}}</td>
              <td>
                <div>{{patient.phone}}</div>
                <div class="email" *ngIf="patient.email">{{patient.email}}</div>
              </td>
              <td>{{patient.national_id}}</td>
              <td>{{patient.created_at | date:'shortDate'}}</td>
              <td>
                <div class="actions">
                  <button class="action-btn view" title="View Details" (click)="navigateToViewPatient(patient)">
                    <i class="fas fa-eye"></i>
                  </button>
                  <button class="action-btn edit" title="Edit" (click)="navigateToEditPatient(patient)">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="action-btn delete" title="Delete" (click)="openDeleteModal(patient)">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- No Patients Message -->
      <div *ngIf="!loading && patients.length === 0" class="no-data-message">
        <i class="fas fa-user-slash"></i>
        <p>No patients found. Add a new patient to get started.</p>
      </div>

      <!-- No Results Message -->
      <div *ngIf="!loading && patients.length > 0 && filteredPatients.length === 0" class="no-data-message">
        <i class="fas fa-search"></i>
        <p>No patients match your search criteria. Try adjusting your filters.</p>
      </div>

      <!-- Pagination -->
      <div class="pagination" *ngIf="!loading && filteredPatients.length > 0">
        <div class="pagination-info">
          Showing {{(currentPage - 1) * itemsPerPage + 1}} to
          {{Math.min(currentPage * itemsPerPage, filteredPatients.length)}}
          of {{filteredPatients.length}} entries
        </div>

        <div class="pagination-controls">
          <button
            [disabled]="currentPage === 1"
            (click)="currentPage = currentPage - 1"
            class="pagination-btn"
          >
            Previous
          </button>

          <span class="page-numbers">
            <button
              *ngFor="let page of [].constructor(totalPages); let i = index"
              [class.active]="currentPage === i + 1"
              (click)="currentPage = i + 1"
              class="page-btn"
            >
              {{i + 1}}
            </button>
          </span>

          <button
            [disabled]="currentPage === totalPages"
            (click)="currentPage = currentPage + 1"
            class="pagination-btn"
          >
            Next
          </button>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" *ngIf="showDeleteModal" (click)="closeDeleteModal()">
  <div class="modal small" (click)="$event.stopPropagation()" >
    <div class="modal-header">
      <h2>Confirm Delete</h2>
      <button class="close-btn" (click)="closeDeleteModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="modal-body">
      <p>Are you sure you want to delete patient <strong>{{ selectedPatient ? getFullName(selectedPatient) : '' }}</strong>?</p>
      <p class="warning">This action cannot be undone.</p>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="closeDeleteModal()">Cancel</button>
      <button type="button" class="btn btn-danger" (click)="deletePatient()">
        Delete
      </button>
    </div>
  </div>
</div>
