<div class="dashboard-container">
  <app-sidebar [isOpen]="isSidebarOpen"></app-sidebar>

  <main class="main-content">
    <app-navbar (toggleSidebar)="toggleSidebar()"></app-navbar>

    <div class="test-results-content">
      <h1>Test Results Entry - Doctor</h1>

      <div class="test-results-container">
        <!-- Pending Tests List -->
        <div class="pending-tests-section">
          <h2>Pending CBC Tests</h2>

          <div class="no-tests" *ngIf="filteredPendingTests.length === 0">
            <p>No pending CBC tests found.</p>
          </div>

          <div class="tests-list" *ngIf="filteredPendingTests.length > 0">
            <div
              *ngFor="let test of filteredPendingTests"
              class="test-item"
              [class.selected]="selectedTest?.id === test.id"
              (click)="selectTest(test)"
            >
              <div class="test-header">
                <span class="invoice">{{ test.invoiceNumber }}</span>
                <span class="date">{{ test.orderedAt | date:'short' }}</span>
              </div>
              <div class="test-details">
                <span class="test-type">CBC Test</span>
                <span class="status">{{ test.status }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Test Results Entry Form -->
        <div class="results-entry-section" *ngIf="selectedTest">
          <div class="patient-info" *ngIf="patientInfo">
            <h3>Patient Information</h3>
            <p><strong>Name:</strong> {{ patientInfo.first_name }} {{ patientInfo.last_name }}</p>
            <p><strong>ID:</strong> {{ patientInfo.national_id }}</p>
            <p><strong>Gender:</strong> {{ patientInfo.gender }}</p>
            <p><strong>DOB:</strong> {{ patientInfo.date_of_birth | date }}</p>
          </div>

          <div class="cbc-form">
            <h3>CBC Test Results</h3>
            <div class="form-row">
              <div class="form-group">
                <label>Hemoglobin (HGB) g/dL</label>
                <input type="number" [(ngModel)]="cbcData.hgb" step="0.1">
              </div>
              <div class="form-group">
                <label>Mean Corpuscular Volume (MCV) fL</label>
                <input type="number" [(ngModel)]="cbcData.mcv" step="0.1">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>MCHC g/dL</label>
                <input type="number" [(ngModel)]="cbcData.mchc" step="0.1">
              </div>
              <div class="form-group">
                <label>White Blood Cells (WBC) K/uL</label>
                <input type="number" [(ngModel)]="cbcData.wbc" step="0.1">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Red Blood Cells (RBC) M/uL</label>
                <input type="number" [(ngModel)]="cbcData.rbc" step="0.1">
              </div>
              <div class="form-group">
                <label>Platelets K/uL</label>
                <input type="number" [(ngModel)]="cbcData.platelets" step="1">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Hematocrit (HCT) %</label>
                <input type="number" [(ngModel)]="cbcData.hct" step="0.1">
              </div>
              <div class="form-group">
                <label>MCH pg</label>
                <input type="number" [(ngModel)]="cbcData.mch" step="0.1">
              </div>
            </div>

            <div class="ai-prediction">
              <button (click)="getPrediction()" [disabled]="isLoading">Get AI Prediction</button>

              <!-- New Result Card -->
              <div class="card result-card animate-in" [class.visible]="isLoading || errorMessage || diagnosisResult">
                <div class="card-header">
                  <h3>Diagnosis Result</h3>
                </div>
                <div class="card-body">
                  <div *ngIf="isLoading" class="info-message">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Analyzing data...</p>
                  </div>

                  <div *ngIf="errorMessage" class="error-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>{{ errorMessage }}</p>
                  </div>

                  <div *ngIf="!diagnosisResult && !isLoading && !errorMessage" class="info-message">
                    <i class="fas fa-file-medical-alt"></i>
                    <p>Results will be displayed here after submission.</p>
                  </div>

                  <div *ngIf="diagnosisResult && !isLoading" class="result-content">
                    <div class="result-item">
                      <label>Diagnosis:</label>
                      <span class="diagnosis-value">{{ diagnosisResult }}</span>
                    </div>
                    <div class="result-item">
                      <label>Confidence:</label>
                      <div class="confidence-bar">
                        <div class="confidence-fill" [style.width.%]="diagnosisConfidence">
                          {{ diagnosisConfidence | number:'1.0-2' }}%
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="form-actions">
              <button class="save-btn" (click)="saveResults()">Save Results</button>
              <button class="cancel-btn" (click)="selectedTest = null; patientInfo = null;">Cancel</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>
